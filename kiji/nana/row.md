\chapterauthor[nana]{久我山菜々}

# 何かタイトル(TBD) ######

## todo:

* 固有名詞チェック
* 文をなおす。
* \#\#\# のとこをなんとかする。
* 温度の測定とマカレルとどっちを先にするかを考える。
* 校正規約に則れば()は全角だが、いつものクセで半角で書いてることに気付いた。
* 開くのだいすきなので、むずかしいのは全部開く

使うかも

* https://gyazo.com/4542f39af358b73532963047db204825
  * https://gyazo.com/0dbc89ae2a1f25f54f448a87d83c60ef
* https://gyazo.com/af5d1c89bdfb1ad0e2d56141218d6435

## はじめに

こんにちは、KMCのnana(Twitter:@nonamea774)です。
最近はKMCではあまり何もしていないね…… ###### このへんもあとでなんか考える

ここ最近の趣味はAliExpressでの買い物です。
色々なものを買っては積んで放置したり、触って遊んだりしています。
今回はその買った物の中で遊んで良かった回の話をしていきます。

今回紹介するのはコチラ！ ##### 今回/最近が多用されすぎてそうなので後でなんとかする。とりあえず書きたいこと一回全部書こ

* CO~2~センサ MH-Z19B
* 温度湿度センサ AHT10

長年の趣味として、ありとあらゆるものを記録するということを行なっています。
自分の家のこれらのデータは、前者についてはそもそも測定値が全く無く、後者も今の値を表示する機械があるだけで、記録はこちらも全くありませんでした。
主な理由としてこれらを測定して記録できるようにコンピュータに送信可能な機器は高価であるということがぴあ #### 後で
「室内の二酸化炭素濃度が上がったらアラートを上げる」というのはよく話題にも出ていましたが、まだ実現はできていなかったので、今回安価なセンサーをみつけたので試していきます。

## 測定開始！

### CO~2~センサ MH-Z19B

こちらを先に買ったので、こちらから行きます。
届いたこれを確認したところ、基板が割れていたので、紛争をしたところ全額refundになりましたが、今回の範囲で必要だったところは壊れてなかったので割れたまま使っています。
AliExpressでの買い物は1割ぐらいがまず届かず、届いた中の1割程度でまたなんらかの不備があり、紛争も買い物の体験の内ということです。
それはともかく、これは500円玉より一回り大きい程度の大きさのセンサで、UARTで話すことができます。
UARTが何であるかは「シリアル通信の……？」ぐらいの認識でしたが、Raspberry PiのUARTのピンへと接続します。
このセンサの場合、他にも利用している人がいたため、計測するためのPythonのモジュールが既にありました。
というよりも、あることをみつけていたから買った という方が正確ですが。
結線してmh-z19(### link?)というモジュールを使うと、以下のような出力を得ることができます(単位はppm)。

```code
$ sudo python -m mh_z19
{'co2': 500}
```

これで室内のCO~2~濃度が測れたのであとは保存するだけ……とはいきません。
このセンサがどう較正されてるかが不明だからです。
一応十分換気されている環境下で、その地点でのCO~2~濃度が400ppmである とゼロキャリブレーション(あわせる値が0じゃなくてもこう言う？)することができます。
が、正確な値を得ることは難しいです。
ここでは次のような解決策を取ることにしました。
**細かな値は気にしないこととする。**
これが妥当な理由としては、本来の目的を思い出すと、十分に換気ができていない時に注意を促したいことであるので、濃度が1ppm(あるいは10ppmとかでも？)違うことにそこまで重要な意味は無いからです。
また、最初に十分に換気した時に測定した値の400ppm台中ほど(正確な値は忘れてしまいました。記録しておくべきでしたね)という値が、気象庁の出している値 https://ds.data.jma.go.jp/ghg/kanshi/ghgp/co2_trend.html からかけ離れておらず、「十分にそれっぽい」からOKということにしました。
一応、別のCO~2~センサであるCCS811も購入して、それによって測定した値と比較もしてみようかと思っていたのですが、まだ届いた段階のまま積まれています。
もっと雑な評価としては、グラフを後述しますが(###### するのか？)、部屋を締め切って測定値の変化を観察しました。
「co2 室内 ガイドライン」で検索して出てきた「建築物環境衛生管理基準の設定根拠の検証について」 https://www.mhlw.go.jp/seisakunitsuite/bunya/kenkou_iryou/kenkou/seikatsu-eisei/gijutukensyuukai/dl/h23_3.pdf にCO~2~の基準値として許容限界が5000ppm、推奨値が1500ppm、目標値が1000ppmとされています。(これは`Ref. 小林陽太郎, 他(1966) ビルディングの環境衛生基準に関する研究. 昭和40年度厚生科学研究報告書.`とあるのでなんかそれっぽいやつの孫引きです。ちゃんとした時ならともかく、家の中で目安にするならこれぐらいでもまぁ……)。 #### 文を切った方が良い 雑に切ったがもう少し考えたほうがいい
これらの値について、測定された値と比較すると、「これぐらいの時間で換気したほうがいいな」と思えるような時間でそれぐらいの値が出ていました。
一旦これにてOKということにします。
目的は果せそうなので。 ### buildして眺めてみたらここ長々と書きすぎてるかも？ uriを脚注に送ればそんなにか？

## Mackerelに送る。

測定しているだけだと意味は無いので(### ほんとうに？ という気がするからそういう脚注をつけるか文を変える)、値の変化について知るためにMackerelへと測定した値を送信します。
これについてはやるだけで、 https://mackerel.io/ja/api-docs/entry/host-metrics#post こうじゃ。 ######
これでグラフの上に測定値をplotして眺めることができます。
https://gyazo.com/c19f5162081fc5071958985f21e64824 が執筆中のグラフですが、9時ぐらいに目覚めてから窓を開けていて、夕方に寒くなってきたので閉めた様子が見えます。
眺めるだけでなく、アラートを仕込むことができます。
この閾値の設定は難しいのですが、前述の基準値1000/1500ppmを一旦設定したところ、発報される頻度もうるさくなく、閉め切ってからしばらくしたら越える程度なので、それぞれwarning/criticalの閾値として設定しています。 #### 文をなんとかしてくれ。
これを動かしはじめてから3ヶ月程度になりますが、ある程度丁度いい数値であるとは思っています。

https://gyazo.com/0dbc89ae2a1f25f54f448a87d83c60ef 閉め切った時の値の上昇と、換気による一気に下降。

いい感じ

## DynamoDBにも送る。

Mackerelは便利なのですが無料枠の範囲だとデータが1日しか保存されません(### add いい脚注: 無料で使わせてくれてありがとうございます。ただ、学生がお家の中で使うにはちょっと高すぎるからお金払ってなくても許して……。学生がお家の中で使うプラン作ってくれた時には払いますから……)。
元々の目的としてはMackerlに送信する段階で達成しているのですが、前述の通り(#### これもさっき使った気がするからなんとかして)全てを保存することは趣味の一つであるので、せっかく測定したデータを捨てていきたくありません。
どこかに保存したいので、現在は一時的な保存先としてDynamoDBに保存しています(### 1文に保存が3回も出てくるのヤバいでしょ)。

プライマリパーティションキー	type (文字列) : CO2の時は文字列co2、後述するAHT10で測定したデータではtemperature
プライマリソートキー	time (数値) : 測定した時点のunix time ### ここなんかうまいことして

こんな感じで保存してるんですがこのテーブル設計ってこれでいいの？ 自信無いので有識者がいたら助けて……。

dynamoDBにraspberry piから送信するためにlambda/api gatewayを利用。
ソースコードは https://github.com/nna774/momochi (認証かかってなくて誰でも嘘の測定値投げられるけどまぁ誰もそんなことしないでしょ……しないでね)
このlambdaの中で受けとったデータをmackerelにもproxyして送ってるのでグラフとアラートも見れてうれしい。

## AHT10

実はUARTではなくI^2^Cで話すというだけで、co2の時とほとんど同じ。
取得するコードもrpiのフォーラムにあったのをパクってきて若干書きかえただけ。
ヤバいコードだったのでなんとかしたいと思いつつ動いてるからな……。

較正については、タニタの温度計TT-580を横に置いてなんとなく値の変化を見たらそれっぽいからいいんではないか。

こっちの値のほうは年間の変動とか見たりしたらもしかしたらおもしろいかも。
CO2のほうは家にいるかどうかの影響が大きくてあんまりそういうみかたをしてもおもしろくなさそう。

## 今後の展望

dynamoにあるやつを日次にまとめてS3に置いたりしたい。
今のテーブルだとやればできるはずだと信じてる。

さっきも書いたけど長期のグラフを描いたりとか。
リアルタイムで長期のグラフを描けたりするともっといいかもね。

Waveshare 4.2inch e-Paper Moduleをアリエクで買ったから、そこに現在の値を出しておうちのダッシュボードにしたらおもしろそうな予感はしてる。
https://github.com/nna774/nanami-dashboard ダッシュボードとして表示するもの自体はだいたい書けてる気がするけど、e-paperに出すところはまだ全然書いてない(叩くべきAPIとかは確認して技術的にはできそうな感じのところまではきてるからやるだけ。やろう)。

## さいごに

https://scrapbox.io/rebuild-kitashirakawa/MH-Z19B%E3%81%A7%E8%87%AA%E5%AE%85%E3%81%AECO2%E6%BF%83%E5%BA%A6%E3%82%92%E6%B8%AC%E5%AE%9A%E3%81%99%E3%82%8B%E3%80%82
と
https://scrapbox.io/rebuild-kitashirakawa/AHT10
も参考に

おもしろいセンサみつけたらどんどん買っていきたーい。
アリエクでのかいものはたのしい！
らむだべんり
